# SAPTest

## 内容说明

在根目录下
  
- pom.xml：maven配置文件
- content.txt：测试输入文件
 
 注：提供的代码解析的输入文件格式为单词之间采用一个空格符分隔
 
## 代码实现流程说明

在com.wxc.saptest下面，分别有三个包，依次实现的对单词计数的三种方式

- com.wxc.saptest.code1

 这是最开始实现的版本，该包下代码设计思路如下：

 1. 采用ForkJoinPool线程池对文件进行处理，code1包中CalTask继承RecursiveTask类，将文件长度传入CalTask类中，由线程池对CalTask类进行调度。
 2. CalTask类主要的功能为将文件按照长度分成多个小任务，每个小任务会处理一段长度的文件，这里每个小任务会调用RandomAccessFile类获取这段长度下文件中的数据，使用HashMap对单词进行个数统计，并依次合并中间结果数据，并返回最终结果  

- com.wxc.saptest.code2

 在上一个版本code1实现中，虽然采用多线程对文件进行读取操作，但是本身会受到磁盘io的限制，而且读取不连续块效率本身不高，采用上面方式RandomAccessFile类读写效率也不高，因此采用直接将文件读入内存后，采用ForkJoinPool再对数据进行操作。
 1. 采用FileChannel的map方法将采用内存映射的方式来处理相应的文件，并使用一个数组来获取相应数据
 2. 将该数组传入CalTask类中，由ForkJoinPool线程池调用该类，采用多线程进行处理
 3. CalTask类主要功能为将数组按照长度分成多个小任务，每个小任务处理一段数组的数据，使用HashMap对单词进行统计，并返回结果

- com.wxc.saptest.code3

 在code2实现方式中，是将文件内容一次性读入数组当中，考虑到内存容量问题并且一次最大只能获取2G数据，这里实现的方式为将文件分块，串行地对每一块文件的内容采用code2中的方式进行单词统计，最后将每块统计数据结果合并到一起。

## 优化考量和优化过程

这里考虑到实际中的不同单词数不会太大，常用的单词在1万以内，因此这里的整个操作流程都在内存中进行，并将最后结果以文件方式输出。

对于大容量文件进行单词频率统计时，时间开销主要分为两个部分，一个是文件读取的io时间开销，一个是进行单词统计的计算。

#### 文件读取优化

在代码实现过程中首先使用的RandomAccessFile的类来对文件进行读取，但是这种方式读取文件效率不高。之后采用MappedByteBuffer对文件进行内存映射的方式来进行读取，加快文件读取效率，若读取文件过大，则将原始文件进行分块读取。

实际测试中对1G文件读取采用MappedByteBuffer来读取数据，在没有磁盘缓存的情况下大概需要8s

#### 单词统计计算

提高计算效率感觉可以从两个方面来考虑，一是增加cpu使用效率，另外一个是提升统计个数算法的效率

关于cpu使用效率来说这里采用多线程的方法，代码中使用ForkJoinPool，在实际测试1G文件中，发现在RecursiveTask的继承类CalTask中，最小任务的阈值设置过大或过小都会增加运行时间，这里在代码中选取1M大小

对于算法的选择，代码中采用的HashMap的方式进行单词个数统计，对于每个处理的CalTask最小任务可以在线性时间统计单词个数，并使用Stream并行方式生成Map结果

实际运行过程中，对于1G文件来说，测试文件中不同单词个数为5个时，运行时间大约为13s；不同单词个数为55万个时，运行时间大约在80s左右，算法的考虑上还有待改进

## mvn命令执行方式

- 执行code1中的代码：`mvn test -Pcode1`
- 执行code2中的代码：`mvn test -Pcode2`
- 执行code3中的代码：`mvn test -Pcode3`

 生成的结果会产生out.txt文件，每一行对应一个单词和相应个数

 可修改pom.xml中profiles节点下面的对应id节点的arguments的值，可以修改输入参数的文件名

## java8新特性使用

在将提取出的每块文件中的数据按照空格分隔后，采用Stream方式统计生成的单词字符串数组当中不同单词个数并生成Map。

在实际测试中，并行的Stream处理会比串行的Stream要略快一些

## 关于笔试时最后一题

对于把10个相同的球放入3个不同的框中（每个框至少一个），可采用隔板的方法，在10个球9个空位中选择2个空位插入隔板，即<img src="http://chart.googleapis.com/chart?cht=tx&chl=$C^2_9$}" style="border:none;">。若把7个球放入3个框中（每个框可以没有），也需要转换成上面的那种情况来计算

对于把m个相同的球放入n个不同的框中（每个框至少一个），计算的公式为<img src="http://chart.googleapis.com/chart?cht=tx&chl=$C^{n-1} _{m-1}$" style="border:none;">(n<=m)